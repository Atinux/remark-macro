!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):n.remarkMacro=r()}(this,function(){"use strict";var n=function(n,r){r.add();for(var e=n.length,t=0,o="name",i=!1;t<e;){var u=n[t++],a=u.charCodeAt(0);91===a?i=!0:93===a?i=!1:61===a||44===a&&i?(o="arg",r.shiftValue()):44===a?(o="name",r.add()):"arg"===o?r.appendValue(u):r.appendKey(u,a)}return r.toJSON()};var r=function(){return{nodes:[],currentNode:null,add:function(){this.currentNode={name:"",args:[]},this.nodes.push(this.currentNode)},appendKey:function(n,r){32!==r&&(this.currentNode.name+=n)},appendValue:function(n){this.currentNode.args[this.currentNode.args.length-1]+=n},shiftValue:function(){this.currentNode.args.push("")},toJSON:function(){return this.nodes.reduce(function(n,r){return n[r.name]=r.args,n},{})}}},e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},t=function n(r,e,t,i,u){var a=null!==i&&void 0!==i;var f=null!==t&&void 0!==t;var c=o(r);if(f&&("number"!=typeof t||t<0||t===1/0))throw new Error("Expected positive finite index or child node");if(a&&(!n(null,i)||!i.children))throw new Error("Expected parent node");if(!e||!e.type||"string"!=typeof e.type)return!1;if(a!==f)throw new Error("Expected both parent and index");return Boolean(c.call(u,e,t,i))};function o(n){if("string"==typeof n)return function(n){return function(r){return Boolean(r&&r.type===n)}}(n);if(null===n||void 0===n)return i;if("object"===(void 0===n?"undefined":e(n)))return("length"in n?function(n){var r=function(n){var r=[],e=n.length,t=-1;for(;++t<e;)r[t]=o(n[t]);return r}(n),e=r.length;return function(){var n=-1;for(;++n<e;)if(r[n].apply(this,arguments))return!0;return!1}}:function(n){return function(r){var e;for(e in n)if(r[e]!==n[e])return!1;return!0}})(n);if("function"==typeof n)return n;throw new Error("Expected function, string, or object as test")}function i(){return!0}var u=d,a=!0,f="skip",c=!1;function d(n,r,e,o){function i(n,u,d){var s;return u=u||(d?0:null),r&&n.type!==r&&!t(r,n,u,d||null)||(s=e(n,u,d||null)),s===c?s:n.children&&s!==f&&function(n,r){var e,t,u=o?-1:1,f=(o?n.length:-1)+u;for(;f>-1&&f<n.length;){if(e=n[f],(t=e&&i(e,f,r))===c)return t;f="number"==typeof t?t:f+u}return a}(n.children,n)===c?c:s}"function"==typeof r&&"function"!=typeof e&&(o=e,e=r,r=null),i(n)}d.CONTINUE=a,d.SKIP=f,d.EXIT=c;var s=/^\[(\w+)(.*)?\]\n/;function l(n){return{type:"BadMacroNode",data:{hName:"div",hChildren:[{type:"text",value:n}]}}}function p(n,r){u(n,"BadMacroNode",function(n){r.message(n.data.hChildren[0].value,n.position.start)})}return function(){var e={};function t(t,o,i){var u=s.exec(o);if(u&&0===u.index&&!i){var a=u[1].trim();if(e[a]){for(var f={macro:a,isClosed:!1,body:[],children:[],props:u[2]},c=o.split("\n");c.length;){var d=c.shift();if(f.body.push(d),d==="[/"+a+"]"){f.isClosed=!0;break}d.startsWith("["+a)||f.children.push(d)}if(f.isClosed){var p=f.props?n(f.props,new r):{},h={transformer:this,eat:t,badNode:l};p.trim=p.trim||["true"],"true"===p.trim[0]&&(f.children=f.children.map(function(n){return n.trim()}));var y=f.children.join("\n"),m=f.body.join("\n"),v=e[a](y,p,h);v?t(m)(v):t(m)}else t(u[0])(l("Unclosed macro: "+a))}}}return{addMacro:function(n,r){if(e[n])throw new Error("Cannot redefine the macro "+n+". One already exists");if("function"!=typeof r)throw new Error("addMacro expects 2nd argument to be a function");return e[n]=r,this},transformer:function(){var n=this.Parser.prototype,r=n.blockMethods,e=n.blockTokenizers;return r.splice(r.indexOf("paragraph"),0,"macro"),e.macro=t,p}}}});
