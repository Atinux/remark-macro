!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.remarkMacro=e()}(this,function(){"use strict";var n=function(n,e){e.add();for(var r=n.length,t=0,o="name",i=!1;t<r;){var u=n[t++],a=u.charCodeAt(0);91===a?i=!0:93===a?i=!1:61===a||44===a&&i?(o="arg",e.shiftValue()):44===a?(o="name",e.add()):"arg"===o?e.appendValue(u):e.appendKey(u,a)}return e.toJSON()};var e=function(){return{nodes:[],currentNode:null,add:function(){this.currentNode={name:"",args:[]},this.nodes.push(this.currentNode)},appendKey:function(n,e){32!==e&&(this.currentNode.name+=n)},appendValue:function(n){this.currentNode.args[this.currentNode.args.length-1]+=n},shiftValue:function(){this.currentNode.args.push("")},toJSON:function(){return this.nodes.reduce(function(n,e){return n[e.name]=e.args,n},{})}}},r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},t=function n(e,r,t,i,u){var a=null!==i&&void 0!==i;var f=null!==t&&void 0!==t;var c=o(e);if(f&&("number"!=typeof t||t<0||t===1/0))throw new Error("Expected positive finite index or child node");if(a&&(!n(null,i)||!i.children))throw new Error("Expected parent node");if(!r||!r.type||"string"!=typeof r.type)return!1;if(a!==f)throw new Error("Expected both parent and index");return Boolean(c.call(u,r,t,i))};function o(n){if("string"==typeof n)return function(n){return function(e){return Boolean(e&&e.type===n)}}(n);if(null===n||void 0===n)return i;if("object"===(void 0===n?"undefined":r(n)))return("length"in n?function(n){var e=function(n){var e=[],r=n.length,t=-1;for(;++t<r;)e[t]=o(n[t]);return e}(n),r=e.length;return function(){var n=-1;for(;++n<r;)if(e[n].apply(this,arguments))return!0;return!1}}:function(n){return function(e){var r;for(r in n)if(e[r]!==n[r])return!1;return!0}})(n);if("function"==typeof n)return n;throw new Error("Expected function, string, or object as test")}function i(){return!0}var u=d,a=!0,f="skip",c=!1;function d(n,e,r,o){function i(n,u,d){var s;return u=u||(d?0:null),e&&n.type!==e&&!t(e,n,u,d||null)||(s=r(n,u,d||null)),s===c?s:n.children&&s!==f&&function(n,e){var r,t,u=o?-1:1,f=(o?n.length:-1)+u;for(;f>-1&&f<n.length;){if(r=n[f],(t=r&&i(r,f,e))===c)return t;f="number"==typeof t?t:f+u}return a}(n.children,n)===c?c:s}"function"==typeof e&&"function"!=typeof r&&(o=r,r=e,e=null),i(n)}d.CONTINUE=a,d.SKIP=f,d.EXIT=c;var s=/^\[(\w+)(.*)?\]\n/;function l(n){return{type:"BadMacroNode",data:{hName:"div",hChildren:[{type:"text",value:n}]}}}function p(n,e){u(n,"BadMacroNode",function(n){e.message(n.data.hChildren[0].value,n.position.start)})}return function(){var r={};function t(t,o,i){var u=s.exec(o);if(u&&0===u.index&&!i){var a=u[1].trim();if(r[a]){for(var f={macro:a,isClosed:!1,body:[],children:[],props:u[2]},c=o.split("\n");c.length;){var d=c.shift();if(f.body.push(d),d==="[/"+a+"]"){f.isClosed=!0;break}d!=="["+a+"]"&&f.children.push(d)}if(f.isClosed){var p=f.props?n(f.props,new e):{},h={transfomer:this,eat:t,badNode:l},y=f.children.join("\n"),v=f.body.join("\n"),m=r[a](y,p,h);m?t(v)(m):t(v)}else t(u[0])(l("Unclosed macro: "+a))}}}return{addMacro:function(n,e){if(r[n])throw new Error("Cannot redefine the macro "+n+". One already exists");if("function"!=typeof e)throw new Error("addMacro expects 2nd argument to be a function");return r[n]=e,this},transformer:function(){var n=this.Parser.prototype,e=n.blockMethods,r=n.blockTokenizers;return e.splice(e.indexOf("paragraph"),0,"macro"),r.macro=t,p}}}});
