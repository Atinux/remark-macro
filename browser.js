!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):n.remarkMacro=r()}(this,function(){"use strict";var n=function(n,r){r.add();for(var e=n.length,t=0,o="name",i=!1;t<e;){var a=n[t++],u=a.charCodeAt(0);91===u?i=!0:93===u?i=!1:61===u||44===u&&i?(o="arg",r.shiftValue()):44===u?(o="name",r.add()):"arg"===o?r.appendValue(a):r.appendKey(a,u)}return r.toJSON()};var r=function(){return{nodes:[],currentNode:null,add:function(){this.currentNode={name:"",args:[]},this.nodes.push(this.currentNode)},appendKey:function(n,r){32!==r&&(this.currentNode.name+=n)},appendValue:function(n){this.currentNode.args[this.currentNode.args.length-1]+=n},shiftValue:function(){this.currentNode.args.push("")},toJSON:function(){return this.nodes.reduce(function(n,r){return n[r.name]=r.args,n},{})}}},e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},t=function n(r,e,t,i,a){var u=null!==i&&void 0!==i;var f=null!==t&&void 0!==t;var c=o(r);if(f&&("number"!=typeof t||t<0||t===1/0))throw new Error("Expected positive finite index or child node");if(u&&(!n(null,i)||!i.children))throw new Error("Expected parent node");if(!e||!e.type||"string"!=typeof e.type)return!1;if(u!==f)throw new Error("Expected both parent and index");return Boolean(c.call(a,e,t,i))};function o(n){if("string"==typeof n)return function(n){return function(r){return Boolean(r&&r.type===n)}}(n);if(null===n||void 0===n)return i;if("object"===(void 0===n?"undefined":e(n)))return("length"in n?function(n){var r=function(n){var r=[],e=n.length,t=-1;for(;++t<e;)r[t]=o(n[t]);return r}(n),e=r.length;return function(){var n=-1;for(;++n<e;)if(r[n].apply(this,arguments))return!0;return!1}}:function(n){return function(r){var e;for(e in n)if(r[e]!==n[e])return!1;return!0}})(n);if("function"==typeof n)return n;throw new Error("Expected function, string, or object as test")}function i(){return!0}var a=s,u=!0,f="skip",c=!1;function s(n,r,e,o){function i(n,a,s){var d;return a=a||(s?0:null),r&&n.type!==r&&!t(r,n,a,s||null)||(d=e(n,a,s||null)),d===c?d:n.children&&d!==f&&function(n,r){var e,t,a=o?-1:1,f=(o?n.length:-1)+a;for(;f>-1&&f<n.length;){if(e=n[f],(t=e&&i(e,f,r))===c)return t;f="number"==typeof t?t:f+a}return u}(n.children,n)===c?c:d}"function"==typeof r&&"function"!=typeof e&&(o=e,e=r,r=null),i(n)}s.CONTINUE=u,s.SKIP=f,s.EXIT=c;var d=/^(\s{2})?\[(\w+)(.*)?\](?!\()\n?/;function p(n){return{type:"BadMacroNode",data:{hName:"div",hChildren:[{type:"text",value:n}]}}}function l(n,r){a(n,"BadMacroNode",function(n){r.message(n.data.hChildren[0].value,n.position.start)})}return function(){var e={};function t(t,o,i){if(o.trim().startsWith("[")){var a=d.exec(o);if(a&&0===a.index&&!i){var u=a[0],f=void 0===a[1]?"":a[1],c=a[2].trim(),s=a[3],l=e[c];if(l){var h={transformer:this,eat:t,badNode:p};return l.inline?function(e,t,o,i){var a=o.$,u=(o.spaces,o.macroName,o.macro),f=o.props,c=f?n(f,new r):{},s=u.fn(c,i);s?e(a)(s):e(a)}(t,0,{$:u,spaces:f,macroName:c,props:s,macro:l},h):function(e,t,o,i){for(var a=o.$,u=o.spaces,f=o.macroName,c=o.macro,s=o.props,d=!1,l=[],h=[],m=t.split("\n");m.length;){var y=m.shift();if(l.push(y),""+y==u+"[/"+f+"]"){d=!0;break}y.startsWith(u+"["+f)||h.push(y.replace(u,""))}if(d){var v=s?n(s,new r):{},g=c.fn(h.join("\n"),v,i);g?e(l.join("\n"))(g):e(l.join("\n"))}else e(a)(p("Unclosed macro: "+f))}(t,o,{$:u,spaces:f,macroName:c,props:s,macro:l},h)}}}}return{addMacro:function(n,r,t){if(e[n])throw new Error("Cannot redefine the macro "+n+". One already exists");if("function"!=typeof r)throw new Error("addMacro expects 2nd argument to be a function");return e[n]={fn:r,inline:t||!1},this},transformer:function(){var n=this.Parser.prototype,r=n.blockMethods,e=n.blockTokenizers;return r.splice(r.indexOf("paragraph"),0,"macro"),e.macro=t,l}}}});
